name: CI - Tests y Validaci√≥n

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Tests Unitarios e Integraci√≥n
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar tests FASE 1
        run: |
          # Solo ejecutar tests de FASE 1 (Optimistic Locking, Deduplicaci√≥n, Promises, Race Conditions)
          npx jest tests/unit/optimisticLocking.test.js
          npx jest tests/unit/deduplication.test.js
          npx jest tests/unit/promiseUtils.test.js
          npx jest tests/integration/raceCondition.test.js
        env:
          # Variables de entorno necesarias para tests
          NODE_ENV: test

      - name: Generar reporte de coverage (FASE 1)
        if: always()
        run: |
          npx jest --coverage \
            tests/unit/optimisticLocking.test.js \
            tests/unit/deduplication.test.js \
            tests/unit/promiseUtils.test.js \
            tests/integration/raceCondition.test.js || true

      - name: Subir coverage a artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  lint:
    name: Linting y Formato
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar ESLint
        run: npm run lint || echo "‚ö†Ô∏è ESLint encontr√≥ warnings"
        continue-on-error: true

      - name: Verificar formato con Prettier
        run: npx prettier --check "**/*.{js,json,md}" || echo "‚ö†Ô∏è Prettier encontr√≥ archivos sin formatear"
        continue-on-error: true

  security:
    name: An√°lisis de Seguridad
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Auditor√≠a de seguridad npm
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Verificar vulnerabilidades cr√≠ticas
        run: npm audit --audit-level=critical

  build:
    name: Verificar Build
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Verificar que no hay errores de sintaxis
        run: node -c api-whatsapp-webhook/index.js

      - name: Listar archivos para deployment
        run: |
          echo "üì¶ Archivos que ser√≠an deployados:"
          ls -la api-*/ timer-*/ core/ bot/

  summary:
    name: Resumen de CI
    runs-on: ubuntu-latest
    needs: [test, lint, security, build]
    if: always()

    steps:
      - name: Resumen
        run: |
          echo "‚úÖ Pipeline de CI completado"
          echo "üìä Resultados:"
          echo "  - Tests FASE 1 (61 tests): ${{ needs.test.result }}"
          echo "  - Linting: ${{ needs.lint.result }}"
          echo "  - Seguridad: ${{ needs.security.result }}"
          echo "  - Build: ${{ needs.build.result }}"
          echo ""
          echo "‚ÑπÔ∏è  Nota: Solo se ejecutan tests de FASE 1"
          echo "  - Optimistic Locking (14 tests)"
          echo "  - Deduplicaci√≥n (10 tests)"
          echo "  - Promise Utils (29 tests)"
          echo "  - Race Conditions (8 tests)"
